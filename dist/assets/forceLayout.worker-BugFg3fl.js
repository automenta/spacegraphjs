(function(){"use strict";let s=[],k=[],l={},d=!1,S=1/0,v=0;function T(){if(s.length<2)return 0;let g=0;const c=new Map(s.map(t=>[t.id,{x:0,y:0,z:0}])),{repulsion:n,centerStrength:i,zSpreadFactor:z,damping:F}=l,p=l.gravityCenter||{x:0,y:0,z:0},y=l.nodePadding||1.2,x=(t,e)=>({x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}),b=t=>t.x*t.x+t.y*t.y+t.z*t.z,N=t=>{const e=Math.sqrt(b(t));return e===0?{x:0,y:0,z:0}:{x:t.x/e,y:t.y/e,z:t.z/e}},m=(t,e)=>({x:t.x*e,y:t.y*e,z:t.z*e}),M=(t,e)=>({x:t.x+e.x,y:t.y+e.y,z:t.z+e.z});for(let t=0;t<s.length;t++){const e=s[t];for(let r=t+1;r<s.length;r++){const a=s[r];let f=x(a,e),o=b(f);o<.001&&(o=.001,f=m(N({x:Math.random()-.5,y:Math.random()-.5,z:Math.random()-.5}),.1));const u=Math.sqrt(o),h=e.radius||10,I=a.radius||10,C=(h+I)*y;let L=-n/o;const P=C-u;P>0&&(L-=n*P**2*.01/u);let D=m(N(f),L);D.z*=z,e.isFixed||c.set(e.id,M(c.get(e.id),D)),a.isFixed||c.set(a.id,x(c.get(a.id),D))}}const q=t=>s.find(e=>e.id===t);if(k.forEach(t=>{const e=q(t.sourceId),r=q(t.targetId);if(!e||!r)return;let a=x(r,e);const f=Math.sqrt(b(a))+1e-6;let o=0;const u=t.constraintParams||{},h=l;switch(t.constraintType){case"rigid":o=(u.stiffness??h.defaultRigidStiffness)*(f-(u.distance??h.defaultElasticIdealLength));break;case"weld":o=(u.stiffness??h.defaultWeldStiffness)*(f-(u.distance??(e.radius||10)+(r.radius||10)));break;case"elastic":default:o=(u.stiffness??h.defaultElasticStiffness)*(f-(u.idealLength??h.defaultElasticIdealLength));break}let I=m(N(a),o);I.z*=z,e.isFixed||c.set(e.id,M(c.get(e.id),I)),r.isFixed||c.set(r.id,x(c.get(r.id),I))}),i>0&&s.forEach(t=>{if(t.isFixed)return;let e=m(x(p,t),i);e.z*=z*.5,c.set(t.id,M(c.get(t.id),e))}),l.enableClustering&&l.clusterStrength>0){const t=new Map;s.forEach(e=>{const r=e.clusterId;if(r==null)return;t.has(r)||t.set(r,{nodeIds:[],centerX:0,centerY:0,centerZ:0,count:0});const a=t.get(r);a.nodeIds.push(e.id),a.centerX+=e.x,a.centerY+=e.y,a.centerZ+=e.z,a.count++}),t.forEach(e=>{if(e.count===0)return;const r={x:e.centerX/e.count,y:e.centerY/e.count,z:e.centerZ/e.count};e.nodeIds.forEach(a=>{const f=q(a);if(!f||f.isFixed)return;let o=m(x(r,f),l.clusterStrength);o.z*=z,c.set(f.id,M(c.get(f.id),o))})})}return s.forEach(t=>{if(t.isFixed)return;const e=c.get(t.id);t.vx=t.vx||0,t.vy=t.vy||0,t.vz=t.vz||0;const r=m(e,1/(t.mass||1));t.vx=(t.vx+r.x)*F,t.vy=(t.vy+r.y)*F,t.vz=(t.vz+r.z)*F,(!isFinite(t.vx)||!isFinite(t.vy)||!isFinite(t.vz))&&(t.vx=0,t.vy=0,t.vz=0);const a=Math.sqrt(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz),f=l.maxSpeed||100;if(a>f){const o=f/a;t.vx*=o,t.vy*=o,t.vz*=o}t.x+=t.vx,t.y+=t.vy,t.z+=t.vz,(!isFinite(t.x)||!isFinite(t.y)||!isFinite(t.z))&&(t.x=0,t.y=0,t.z=0,t.vx=0,t.vy=0,t.vz=0),g+=.5*(t.mass||1)*(t.vx*t.vx+t.vy*t.vy+t.vz*t.vz)}),g}function w(){if(d||s.length<2)return;d=!0,v=Date.now();const g=()=>{if(!d)return;S=T(),self.postMessage({type:"positionsUpdate",positions:s.map(n=>({id:n.id,x:n.x,y:n.y,z:n.z})),energy:S});const c=Date.now()-v;l.autoStopDelay&&S<l.minEnergyThreshold&&c>l.autoStopDelay?E():setTimeout(g,16)};g()}function E(){d&&(d=!1,self.postMessage({type:"stopped",energy:S}))}self.onmessage=function(g){const{type:c,payload:n}=g.data;switch(c){case"init":s=n.nodes,k=n.edges,l=n.settings,s.forEach(i=>{i.vx=i.vx||0,i.vy=i.vy||0,i.vz=i.vz||0});break;case"start":w();break;case"stop":E();break;case"updateSettings":l={...l,...n.settings},d?v=Date.now():s.length>0&&w();break;case"kick":if(s.length===0)break;v=Date.now(),S=1/0,s.forEach(i=>{i.isFixed||(i.vx+=(Math.random()-.5)*(n.intensity||1),i.vy+=(Math.random()-.5)*(n.intensity||1),i.vz+=(Math.random()-.5)*(n.intensity||1)*l.zSpreadFactor)}),d||w();break;case"addNode":{const i=n.node;i.vx=0,i.vy=0,i.vz=0,s.push(i),!d&&s.length>0?w():d&&(v=Date.now());break}case"removeNode":{s=s.filter(i=>i.id!==n.nodeId),s.length<2&&d?E():d&&(v=Date.now());break}case"addEdge":k.push(n.edge),d&&(v=Date.now());break;case"removeEdge":k=k.filter(i=>!(i.sourceId===n.sourceId&&i.targetId===n.targetId)),d&&(v=Date.now());break;case"updateNodeState":{const{nodeId:i,isFixed:z,isPinned:F,position:p}=n,y=s.find(x=>x.id===i);if(!y)break;y.isFixed=z,y.isPinned=F,z&&(y.vx=y.vy=y.vz=0),p&&(y.x=p.x,y.y=p.y,y.z=p.z),d&&(v=Date.now());break}default:console.warn("ForceLayout Worker: Unknown message type:",c)}}})();
