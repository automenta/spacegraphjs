<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
        <title>SpaceGraph - Dashboard Example</title>
        <link
            href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>"
            rel="icon"
        />
        <link href="index.css" rel="stylesheet" />
        <style>
            body {
                font-family: var(--font-family);
            }
            #graph-container {
                position: fixed;
                inset: 0;
            }

            /* Data Source Widget Styles */
            .html-app-node.data-source-widget-node {
                padding: 15px;
                border-radius: 8px;
                text-align: center;
            }
            .data-source-widget-node button {
                padding: 10px 15px;
                margin-top: 10px;
                cursor: pointer;
                border: none;
                border-radius: 5px;
                background-color: var(--accent-color);
                color: white;
                font-weight: bold;
            }
            .data-source-widget-node button:hover {
                background-color: var(--accent-color-darker);
            }

            /* Display Widget Styles */
            .html-app-node.display-widget-node {
                padding: 15px;
                border-radius: 8px;
                text-align: center;
            }
            .display-widget-node .widget-content {
                margin-top: 10px;
                padding: 10px;
                background-color: rgba(0,0,0,0.1);
                border-radius: 5px;
                min-height: 50px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: var(--font-mono);
                font-size: 0.9em;
            }
        </style>
    </head>
    <body>
        <div id="graph-container">
            <!-- SpaceGraph canvas and CSS3D container will be injected here by spacegraph.js -->
        </div>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.166.1/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.166.1/examples/jsm/",
                    "gsap": "https://cdn.jsdelivr.net/npm/gsap@3.12.5/index.js"
                }
            }
        </script>
        <script type="module">
            import { SpaceGraph } from './spacegraph.js';
            import { HtmlAppNode } from './js/HtmlAppNode.js';

            // --- Data Source Node ---
            class DataSourceNode extends HtmlAppNode {
                onInit() {
                    this.htmlElement.innerHTML = `
                        <h4>${this.data.label}</h4>
                        <button id="emit-data-btn">Generate & Emit Data</button>
                    `;
                    const emitButton = this.getChild('#emit-data-btn');
                    this.stopEventPropagation(emitButton);

                    emitButton.addEventListener('click', () => {
                        const data = {
                            value: Math.floor(Math.random() * 100),
                            timestamp: new Date().toLocaleTimeString()
                        };
                        console.log(`${this.id} emitting 'value_out':`, data);
                        this.emit('value_out', data);
                    });
                }
            }

            const dataSourceNodeDefinition = {
                typeName: 'data-source-widget',
                nodeClass: DataSourceNode,
                getDefaults: (nodeInst) => ({
                    width: 200,
                    height: 120,
                    label: 'Data Emitter',
                    backgroundColor: 'hsl(180, 70%, 80%)', // Light cyan
                    ports: {
                        outputs: { value_out: { label: 'Value Out', type: 'object' } }
                    }
                })
            };

            // --- Display Widget Node ---
            class DisplayWidgetNode extends HtmlAppNode {
                contentDiv = null;

                onInit() {
                    this.htmlElement.innerHTML = `
                        <h4>${this.data.label}</h4>
                        <div class="widget-content">Waiting for data...</div>
                    `;
                    this.contentDiv = this.getChild('.widget-content');
                    // No specific event listeners needed here, data updates via onDataUpdate
                }

                onDataUpdate(updatedData) {
                    // super.onDataUpdate(updatedData); // For base class handling if any

                    if (updatedData.data_in !== undefined) {
                        const data = this.data.data_in; // Data is already merged into this.data
                        if (this.contentDiv && data) {
                            this.contentDiv.innerHTML = `
                                Value: <strong>${data.value}</strong><br>
                                Time: ${data.timestamp}
                            `;
                            console.log(`${this.id} received data for 'data_in':`, data);
                        }
                    }
                }
            }

            const displayWidgetNodeDefinition = {
                typeName: 'display-widget',
                nodeClass: DisplayWidgetNode,
                getDefaults: (nodeInst) => ({
                    width: 250,
                    height: 150,
                    label: 'Display Widget',
                    backgroundColor: 'hsl(60, 70%, 85%)', // Light yellow
                    ports: {
                        inputs: { data_in: { label: 'Data In', type: 'object' } }
                    }
                })
            };

            // --- Graph Setup ---
            function initGraph() {
                const container = document.getElementById('graph-container');
                if (!container) {
                    console.error("Container #graph-container not found!");
                    return;
                }

                const space = new SpaceGraph(container);
                window.space = space; // For debugging

                // Register node types
                space.registerNodeType(dataSourceNodeDefinition.typeName, dataSourceNodeDefinition);
                space.registerNodeType(displayWidgetNodeDefinition.typeName, displayWidgetNodeDefinition);

                // Add nodes
                const source = space.addNode({
                    type: 'data-source-widget',
                    id: 'source-1',
                    x: -250,
                    y: 0
                });

                const display1 = space.addNode({
                    type: 'display-widget',
                    id: 'display-A',
                    label: 'Display A',
                    x: 150,
                    y: -100
                });

                const display2 = space.addNode({
                    type: 'display-widget',
                    id: 'display-B',
                    label: 'Display B',
                    x: 150,
                    y: 100
                });

                // Connect ports
                if (source && display1 && display2) {
                    space.addEdge(source, display1, {
                        sourcePort: 'value_out',
                        targetPort: 'data_in'
                    });
                    space.addEdge(source, display2, {
                        sourcePort: 'value_out',
                        targetPort: 'data_in'
                    });
                }

                // Layout and center
                space.layoutEngine.runOnce(150);
                space.centerView();

                console.log("Dashboard example initialized. Click the button on 'Data Emitter' node.");
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initGraph);
            } else {
                initGraph();
            }
        </script>
    </body>
</html>
```
