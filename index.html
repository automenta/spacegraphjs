<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
        <link
            href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>"
            rel="icon"
        />
        <link href="src/index.css" rel="stylesheet" />
    </head>
    <body>
        <div id="toolbar"></div>

        <div id="page-selector">
            <!-- Buttons will be added here by JavaScript -->
        </div>
        <div id="hud">
            <!-- Page description will be loaded here -->
        </div>

        <div id="mindmap-container">
            <canvas id="webgl-canvas"></canvas>
            <div id="css3d-container"></div>
        </div>

        <div class="context-menu" id="context-menu"></div>

        <div class="dialog" id="confirm-dialog">
            <p id="confirm-message">Are you sure?</p>
            <button id="confirm-yes">Yes</button>
            <button id="confirm-no">No</button>
        </div>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.166.1/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.166.1/examples/jsm/",
                    "gsap": "https://cdn.jsdelivr.net/npm/gsap@3.12.5/index.js"
                }
            }
        </script>
        <script type="module">
            import * as S from './src/index.js';
            import { pages } from './src/examples/pages.js';

            let space; // Make space globally accessible within this script
            const pageSelectorEl = S.$('#page-selector');
            const hudEl = S.$('#hud');

            function populatePageSelector() {
                if (!pageSelectorEl) return;
                pageSelectorEl.innerHTML = ''; // Clear existing buttons

                pages.forEach(page => {
                    const button = document.createElement('button');
                    button.textContent = page.title;
                    button.dataset.pageId = page.id;
                    button.addEventListener('click', () => loadPage(page.id));
                    pageSelectorEl.appendChild(button);
                });
            }

            function updateActiveButton(pageId) {
                if (!pageSelectorEl) return;
                const buttons = pageSelectorEl.querySelectorAll('button');
                buttons.forEach(button => {
                    if (button.dataset.pageId === pageId) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }

            async function loadPage(pageId) {
                if (!space) {
                    console.error('SpaceGraph not initialized yet.');
                    return;
                }

                const page = pages.find(p => p.id === pageId);
                if (!page) {
                    console.error(`Page with id "${pageId}" not found.`);
                    return;
                }

                // Clear previous graph content
                space.clearAll(); // Assuming a method like clearAll exists

                if (hudEl) {
                    hudEl.innerHTML = page.description;
                }

                // Create the new graph
                if (typeof page.createGraph === 'function') {
                    page.createGraph(space);
                } else {
                    console.error(`createGraph function missing for page "${pageId}"`);
                }

                // Re-initialize layout and view
                const layoutPlugin = space.plugins.getPlugin('LayoutPlugin');
                const layoutManager = layoutPlugin?.layoutManager;
                if (layoutManager) {
                    layoutManager.kick?.(); // Re-run layout physics
                } else {
                    console.warn('LayoutPlugin or LayoutManager not available for kicking layout.');
                }

                space.centerView(null, 0.8);
                updateActiveButton(pageId);
                console.log(`Loaded page: ${page.title}`);
            }

            async function init() {
                const container = S.$('#mindmap-container');
                const contextMenuEl = S.$('#context-menu');
                const confirmDialogEl = S.$('#confirm-dialog');

                if (!container || !contextMenuEl || !confirmDialogEl || !pageSelectorEl || !hudEl) {
                    console.error('Init Failed: Missing DOM elements for graph, page selector, or HUD.');
                    if (container) container.innerHTML = "<p style='color:red; padding: 20px;'>Error: Critical HTML elements are missing.</p>";
                    return;
                }

                try {
                    space = new S.SpaceGraph(container, {
                        ui: {
                            contextMenuElement: contextMenuEl,
                            confirmDialogElement: confirmDialogEl,
                        },
                        // Add any default options if needed
                    });
                    await space.init();

                    populatePageSelector();

                    if (pages.length > 0) {
                        await loadPage(pages[0].id); // Load the first page by default
                    } else {
                        console.warn('No pages defined in pages.js');
                        if (hudEl) hudEl.innerHTML = "<p>No pages available to display.</p>";
                    }

                    space.animate(); // Start animation loop

                    window.space = space; // Expose space to global for debugging
                } catch (error) {
                    console.error('Init Failed:', error);
                    container.innerHTML = `<div style="color: red; padding: 20px;">Error initializing: ${error.message}<br><pre>${error.stack}</pre></div>`;
                }
            }

            document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();
        </script>
    </body>
</html>
